#!/bin/bash
#####  Constructed by HPC everywhere #####
#SBATCH --mail-user=sheybani@iu.edu
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=30
#SBATCH --time=0-20:00:00
#SBATCH --mem-per-cpu 8G
#SBATCH --partition=gpu
#SBATCH --gpus 4
#SBATCH --mail-type=FAIL,BEGIN,END
#SBATCH --job-name=jobs222
#SBATCH --output=jobs222_Out
#SBATCH --error=jobs222_Err

######  Module commands #####



######  Job commands go below this line #####
AUG="b"
T_NEIGH=2

SCRIPT_NAME="train_sep7_seq.py"
n_train_epochs=1
n_iter=800
SAVEDIR="/N/scratch/sheybani/trainedmodels/multistage/simclr/sep8seq/"
GROUPS_SHAPE="3,-1"



PROTOCOL="222"
DATASEED=0
OTHERSEED=$(($RANDOM%1222))

python ~/github/PretrainingInfantEgocentric/train/train_sep7_seq.py -prot $PROTOCOL -data_seed $DATASEED -other_seed=$OTHERSEED -savedir $SAVEDIR -aug $AUG --n_epoch $n_train_epochs --t_neigh $T_NEIGH --script $SCRIPT_NAME --data_groups_shape $GROUPS_SHAPE --n_iter=$n_iter


# Validation

n_val_epochs=30
ds_task="toybox"

model_fname="model_"$PROTOCOL"_stage_2_seed_"$DATASEED"_"$OTHERSEED".pt"
model_fpath=$SAVEDIR$model_fname

python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

ds_task="cifar10"
python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

# should finish in 2.5hours
#---------------------------------




PROTOCOL="222"
DATASEED=1
OTHERSEED=$(($RANDOM%1222))

python ~/github/PretrainingInfantEgocentric/train/train_sep7_seq.py -prot $PROTOCOL -data_seed $DATASEED -other_seed=$OTHERSEED -savedir $SAVEDIR -aug $AUG --n_epoch $n_train_epochs --t_neigh $T_NEIGH --script $SCRIPT_NAME --data_groups_shape $GROUPS_SHAPE --n_iter=$n_iter


# Validation

n_val_epochs=30
ds_task="toybox"

model_fname="model_"$PROTOCOL"_stage_2_seed_"$DATASEED"_"$OTHERSEED".pt"
model_fpath=$SAVEDIR$model_fname

python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

ds_task="cifar10"
python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

# should finish in 2.5hours
#---------------------------------




PROTOCOL="222"
DATASEED=2
OTHERSEED=$(($RANDOM%1222))

python ~/github/PretrainingInfantEgocentric/train/train_sep7_seq.py -prot $PROTOCOL -data_seed $DATASEED -other_seed=$OTHERSEED -savedir $SAVEDIR -aug $AUG --n_epoch $n_train_epochs --t_neigh $T_NEIGH --script $SCRIPT_NAME --data_groups_shape $GROUPS_SHAPE --n_iter=$n_iter


# Validation

n_val_epochs=30
ds_task="toybox"

model_fname="model_"$PROTOCOL"_stage_2_seed_"$DATASEED"_"$OTHERSEED".pt"
model_fpath=$SAVEDIR$model_fname

python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

ds_task="cifar10"
python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

# should finish in 2.5hours
#---------------------------------





PROTOCOL="222"
DATASEED=0
OTHERSEED=$(($RANDOM%1222))

python ~/github/PretrainingInfantEgocentric/train/train_sep7_seq.py -prot $PROTOCOL -data_seed $DATASEED -other_seed=$OTHERSEED -savedir $SAVEDIR -aug $AUG --n_epoch $n_train_epochs --t_neigh $T_NEIGH --script $SCRIPT_NAME --data_groups_shape $GROUPS_SHAPE --n_iter=$n_iter


# Validation

n_val_epochs=30
ds_task="toybox"

model_fname="model_"$PROTOCOL"_stage_2_seed_"$DATASEED"_"$OTHERSEED".pt"
model_fpath=$SAVEDIR$model_fname

python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

ds_task="cifar10"
python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

# should finish in 2.5hours
#---------------------------------


PROTOCOL="222"
DATASEED=1
OTHERSEED=$(($RANDOM%1222))

python ~/github/PretrainingInfantEgocentric/train/train_sep7_seq.py -prot $PROTOCOL -data_seed $DATASEED -other_seed=$OTHERSEED -savedir $SAVEDIR -aug $AUG --n_epoch $n_train_epochs --t_neigh $T_NEIGH --script $SCRIPT_NAME --data_groups_shape $GROUPS_SHAPE --n_iter=$n_iter


# Validation

n_val_epochs=30
ds_task="toybox"

model_fname="model_"$PROTOCOL"_stage_2_seed_"$DATASEED"_"$OTHERSEED".pt"
model_fpath=$SAVEDIR$model_fname

python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

ds_task="cifar10"
python ~/github/PretrainingInfantEgocentric/downstream/downstream_wrapper_ddp.py --task=$ds_task --model_path=$model_fpath --outdir=$SAVEDIR --epochs=$n_val_epochs

# should finish in 2.5hours
#---------------------------------